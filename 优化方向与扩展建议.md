# 金银定投回测项目 — 优化方向与扩展建议

基于当前实现，可从**策略与风险**、**数据与回测**、**优化方法**、**工程与可复现**四方面继续优化或扩展。

---

## 一、策略与风险

### 1.1 让 CVaR 约束真正生效

- **现状**：95% CVaR 年化约 56%～65%，远高于 10%，约束长期不满足。
- **方向**：
  - **放宽约束**：如 CVaR ≤ 30%/年，或改为「目标 CVaR 尽量小」的软约束（惩罚项）。
  - **降仓位**：单次定投金额或总投入按比例缩小，使组合波动和尾部损失下降。
  - **多目标**：同时优化「夏普」与「CVaR」，用 Pareto 前沿或加权目标，在收益与风险间权衡。

### 1.2 动态 / 自适应策略

- **定投频率**：根据近期波动（如 20 日波动率）自动切换周/双周/月频（高波动时降低频率）。
- **配比**：用滚动窗口（如过去 60 日）重新估计最优黄金配比，实现「时变配比」。
- **择时**：在估值或动量指标（如金/银相对均线位置）上做简单过滤，减少明显高估时段的定投量（需避免未来数据泄露）。

### 1.3 风险指标扩展

- **最大回撤约束**：在优化中增加「最大回撤 ≤ 某阈值」的约束。
- **VaR**：除 CVaR 外，报告 95% VaR，便于与监管或风控口径对齐。
- **下行波动率**：仅用负收益计算波动率，作为目标或约束，更贴近「下行风险」控制。

---

## 二、数据与回测

### 2.1 样本期与稳健性

- **多区间**：增加 2020–2024 等不同市场阶段（牛/熊/震荡），检验最优频率与配比是否稳定。
- **样本外**：用 2023 及以前数据优化，2024/2025 做样本外测试，避免过拟合。
- **滚动回测**：每月或每季度用过去 N 年数据重新优化，再在下一期执行，模拟「实盘可执行」的调参方式。

### 2.2 数据源与标的

- **多数据源**：除 yfinance 外，接入 CSV、数据库或其它 API（如 Alpha Vantage），做数据交叉验证。
- **标的扩展**：加入 GLD/SLV 等 ETF，或其它贵金属/商品，做「金+银+其它」多资产定投与配比优化。
- **汇率**：若以人民币记账，可引入 USD/CNY 序列，将美元计价的金银价换算为人民币收益再算夏普/CVaR。

### 2.3 回测严谨性

- **幸存者偏差**：明确所用标的在回测期内一直存在、未退市。
- **前视偏差**：确保定投日、价格、成本均在当日可得，无未来信息。
- **滑点与冲击**：对较大单次金额引入成交量或 AUM 比例约束，或加大滑点/冲击成本，检验策略在「大资金」下的表现。

---

## 三、优化方法

### 3.1 求解器与约束

- **全局搜索**：对离散频率 + 连续配比，可尝试 `scipy.optimize.differential_evolution` 或 `optuna` 做全局探索，避免陷入局部最优。
- **约束形式**：将 CVaR 写成可微或可估形式（如样本 CVaR + 梯度近似），便于 SLSQP 稳定收敛；或使用 `cvxpy` 做凸近似（若可写成凸问题）。
- **鲁棒优化**：在「最坏情景」（如历史最差 N 日收益）下优化配比，使策略在极端情形下更稳健。

### 3.2 目标与评估

- **多目标**：夏普 + CVaR + 最大回撤的加权和或 Pareto 前沿，便于按风险偏好选点。
- **统计显著性**：对夏普比做 bootstrap 或 Newey-West 调整，报告置信区间，判断「优于基准」是否显著。
- **换手与成本**：在目标中加入「交易次数」或「总成本」惩罚，偏好低频、低换手方案。

---

## 四、工程与可复现

### 4.1 代码结构

- **模块化**：拆成 `data/`（拉取、清洗）、`backtest/`（定投引擎）、`optimize/`（目标与约束）、`report/`（指标表与图表），便于单测和替换。
- **配置文件**：用 YAML/JSON 管理日期区间、标的、成本、约束阈值等，避免改代码才能改参数。
- **命令行**：`python run.py --start 2023-01-01 --end 2025-12-31 --config config.yaml`，方便批量实验与脚本调用。

### 4.2 可复现与版本

- **随机种子**：若有随机（如 bootstrap、蒙特卡洛），固定 `np.random.seed` 并记录在配置或 README。
- **依赖锁定**：`pip freeze > requirements_lock.txt` 或使用 `poetry`/`conda env export`，便于他人复现环境。
- **数据快照**：对关键回测使用「一次下载、本地缓存」的行情数据，并注明数据日期与来源，便于复现结果。

### 4.3 测试与文档

- **单元测试**：对 CVaR 计算、定投日期生成、成本计算等写 pytest，防止重构时出错。
- **示例 Notebook**：用 Jupyter 跑一遍「数据 → 回测 → 优化 → 图表」流程，并导出为 HTML，方便展示与审阅。
- **中英文 README**：当前已有 README.md / README_CN.md，可补充「优化方向」链接到本文档。

---

## 五、可优先做的几项

| 优先级 | 方向 | 说明 |
|--------|------|------|
| 高 | 放宽或软化 CVaR 约束 | 让优化解落在可行域内，或显式做「夏普–CVaR」权衡 |
| 高 | 多区间 / 样本外检验 | 验证最优频率与配比在不同年份是否稳定 |
| 中 | 配置外置 + 模块化 | 便于改参数、扩展标的和策略 |
| 中 | 最大回撤约束或目标 | 与实盘风控更贴近 |
| 低 | 动态频率/配比 | 提升策略适应性，但实现与评估成本更高 |
| 低 | Bootstrap 夏普置信区间 | 增强结论可信度 |

按当前项目目标（作业/课程展示 vs 实盘参考），可先选 1～2 项实现，再逐步扩展。若你指定一个方向（如「只要多区间回测」或「只要配置外置」），可以再细化成具体改代码步骤。
